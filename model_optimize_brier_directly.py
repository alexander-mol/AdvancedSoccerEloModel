import re
import pandas as pd
import numpy as np
import pickle
from sklearn.linear_model import LinearRegression
from sklearn.linear_model import LogisticRegression
from sklearn.linear_model import Ridge
from scipy.stats import poisson
from scipy.optimize import minimize

import utils

with open('2010-2018_patched_df.p', 'rb') as f:
    df = pickle.load(f)


# add features
df['Elo_Score_Diff'] = df['Elo_Score_Before_2'] - df['Elo_Score_Before_1']

df['Score_Diff^2'] = df['Elo_Score_Diff'] * df['Elo_Score_Diff']
df['LN(Elo_Score_Before_1)'] = np.log(df['Elo_Score_Before_1'])
df['LN(Elo_Score_Before_2)'] = np.log(df['Elo_Score_Before_2'])
df['Elo_Score_Product'] = df['Elo_Score_Before_1'] * df['Elo_Score_Before_2']
df['LN(Elo_Score_Product)'] = np.log(df['Elo_Score_Product'])
df['Friendly_Flag'] = (df['Competition'] == 'Friendly') * 1
df['Home_Advantage'] = df.apply(lambda x: 1 if x['Country_1'] in x['Location'] else -1 if x['Country_2'] in x['Location'] else 0, axis=1)

features = ['Elo_Score_Before_1', 'Elo_Score_Before_2', 'Elo_Score_Diff', 'Score_Diff^2', 'LN(Elo_Score_Before_1)',
            'LN(Elo_Score_Before_2)', 'Elo_Score_Product', 'LN(Elo_Score_Product)', 'Friendly_Flag', 'Home_Advantage']

X = df[features]
y_c = df['Outcome']

outcome_to_int_map = {'T1':0, 'T2': 1, 'draw':2}
outcome_int = y_c.apply(lambda x: outcome_to_int_map[x])

coefs_1 = np.random.rand(len(features)+1) / 1000000000
coefs_2 = np.random.rand(len(features)+1) / 1000000000
mid = len(coefs_1)

def brier_on_data(coefs):
    e1 = utils.apply_regression(X, coefs[:mid])
    e2 = utils.apply_regression(X, coefs[mid:])
    predicted_outcome_probs = utils.consolidated_outcome(e1, e2)

    actual_outcome_prob = predicted_outcome_probs[0] * (y_c == 'T1') \
                          + predicted_outcome_probs[1] * (y_c == 'T2') \
                          + predicted_outcome_probs[2] * (y_c == 'draw')
    return utils.brier_score(actual_outcome_prob)

print(brier_on_data(np.array([-3.20889907e-02, 1.10602436e-02, 1.26205546e-02, -3.74474669e-03, -5.94367708e-06, -2.79859775e-01,
         -2.83783138e-01, -8.36086136e-06, -5.63650882e-01, -9.45846565e-02, -8.37924943e-01, -6.82393779e-02,
         1.32464843e-02, 1.29986712e-02, 4.68819670e-03, -6.54666855e-06, -4.05330334e-01, -4.08653704e-01,
         -8.81567097e-06, -8.13978862e-01, 7.15892934e-02, 7.69420643e-01])))
# utils.optimize(brier_on_data, np.concatenate((coefs_1, coefs_2)), learning_rate=0.1)
# res = minimize(brier_on_data, np.concatenate((coefs_1, coefs_2)))
# print(res)
# print(res.x)


"""
RESULTS

      fun: 0.3060263094341047
 hess_inv: array([[  1.00559059e+00,  -2.00806642e-03,  -1.43620034e-03,
          4.70001042e-06,  -8.70870966e-07,   6.46923715e-02,
          6.65886046e-02,   7.07529951e-07,   1.31282652e-01,
         -1.23220099e-02,   2.45827870e-01,   2.79927921e-02,
         -4.52336373e-03,  -3.19153312e-03,  -2.12478243e-04,
         -7.58939805e-07,   1.73940099e-01,   1.75416022e-01,
          1.93822141e-06,   3.49358813e-01,   7.50413498e-03,
         -2.62460772e-01],
       [ -2.00806643e-03,   3.33880247e-01,  -3.33088477e-01,
          3.33179161e-01,   5.80215478e-08,  -2.00194127e-02,
         -2.02394544e-02,  -1.71613784e-07,  -4.02592429e-02,
          2.90210767e-03,  -5.79310210e-02,  -6.47413497e-03,
          1.12720167e-03,   6.65975322e-04,  -8.54456756e-05,
          2.69591915e-07,  -4.02323285e-02,  -4.05618672e-02,
         -4.56456319e-07,  -8.07948278e-02,  -1.82755252e-03,
          6.13779110e-02],
       [ -1.43620035e-03,  -3.33088477e-01,   3.33654760e-01,
         -3.33194563e-01,   3.47732076e-08,  -1.40772309e-02,
         -1.46654672e-02,  -1.11082403e-07,  -2.87429999e-02,
          1.51659451e-03,  -4.11828362e-02,  -4.65032972e-03,
          7.06127041e-04,   5.70628011e-04,   1.21477378e-04,
          2.36825799e-08,  -2.88535929e-02,  -2.90940299e-02,
         -3.16099718e-07,  -5.79480315e-02,  -9.72034324e-04,
          4.33381941e-02],
       [  4.70001428e-06,   3.33179161e-01,  -3.33194563e-01,
          3.33587139e-01,   9.43374852e-08,   3.09108683e-04,
         -1.91605341e-04,   2.04215009e-08,   1.17465052e-04,
         -4.11545501e-04,  -2.28759496e-04,  -9.11915935e-05,
         -9.69030928e-05,   1.10871209e-04,   1.96507145e-04,
         -1.26995260e-07,  -5.45137236e-04,  -5.56502622e-04,
          7.42332696e-09,  -1.10161309e-03,   2.00126444e-04,
          1.25961554e-04],
       [ -8.70870971e-07,   5.80215501e-08,   3.47732096e-08,
          9.43374836e-08,   2.36430722e-09,  -5.53233892e-06,
         -5.34625888e-06,  -4.50035891e-12,  -1.08785747e-05,
          2.00701498e-06,  -4.49666859e-06,  -7.09995091e-07,
          4.99022577e-08,   1.25126644e-07,   5.98111688e-08,
          5.61532674e-10,  -4.53428833e-06,  -4.66806736e-06,
         -3.40101642e-11,  -9.20269590e-06,  -9.85895893e-07,
          5.74032024e-06],
       [  6.46923716e-02,  -2.00194127e-02,  -1.40772309e-02,
          3.09108674e-04,  -5.53233883e-06,   1.71320267e+00,
          7.33356857e-01,   6.74091416e-06,   1.44657697e+00,
         -1.24449074e-01,   2.55962827e+00,   2.88996807e-01,
         -4.72719875e-02,  -3.20903385e-02,  -1.03465140e-03,
         -8.98058723e-06,   1.79507268e+00,   1.81014215e+00,
          1.98435496e-05,   3.60524224e+00,   7.43153106e-02,
         -2.71977380e+00],
       [  6.65886048e-02,  -2.02394544e-02,  -1.46654672e-02,
         -1.91605343e-04,  -5.34625879e-06,   7.33356857e-01,
          1.75393934e+00,   6.91685872e-06,   1.48731410e+00,
         -1.27421867e-01,   2.62831429e+00,   2.96533991e-01,
         -4.85430089e-02,  -3.28300678e-02,  -9.93740643e-04,
         -9.45571656e-06,   1.84180062e+00,   1.85728239e+00,
          2.03183246e-05,   3.69911111e+00,   7.59495222e-02,
         -2.79185692e+00],
       [  7.07529953e-07,  -1.71613784e-07,  -1.11082403e-07,
          2.04215010e-08,  -4.50035810e-12,   6.74091417e-06,
          6.91685873e-06,   6.67659699e-11,   1.36579057e-05,
         -9.22185698e-07,   1.95105053e-05,   2.17484783e-06,
         -3.72258402e-07,  -2.37474685e-07,   5.78847672e-09,
         -5.64257349e-11,   1.34996270e-05,   1.36072150e-05,
          1.57302289e-10,   2.71070513e-05,   5.34047113e-07,
         -2.06537183e-05],
       [  1.31282652e-01,  -4.02592429e-02,  -2.87429998e-02,
          1.17465041e-04,  -1.08785745e-05,   1.44657697e+00,
          1.48731410e+00,   1.36579057e-05,   3.93392642e+00,
         -2.51873506e-01,   5.18800019e+00,   5.85537245e-01,
         -9.58160412e-02,  -6.49211049e-02,  -2.02841432e-03,
         -1.84364952e-05,   3.63691332e+00,   3.66746489e+00,
          4.01622971e-05,   7.30443373e+00,   1.50266369e-01,
         -5.51169130e+00],
       [ -1.23220098e-02,   2.90210765e-03,   1.51659450e-03,
         -4.11545489e-04,   2.00701500e-06,  -1.24449073e-01,
         -1.27421866e-01,  -9.22185693e-07,  -2.51873505e-01,
          1.02030182e+00,  -3.89671981e-01,  -4.41769475e-02,
          7.60046577e-03,   4.40314261e-03,  -6.39342029e-04,
          2.71597678e-06,  -2.74680970e-01,  -2.77018831e-01,
         -2.93986525e-06,  -5.51704084e-01,  -1.34625628e-02,
          4.14437236e-01],
       [  2.45827872e-01,  -5.79310213e-02,  -4.11828364e-02,
         -2.28759322e-04,  -4.49666809e-06,   2.55962828e+00,
          2.62831430e+00,   1.95105053e-05,   5.18800021e+00,
         -3.89671982e-01,   9.51328548e+00,   9.44084961e-01,
         -1.57647219e-01,  -1.01614378e-01,   1.41680354e-03,
         -3.08327410e-05,   5.85909735e+00,   5.90730506e+00,
          6.49029952e-05,   1.17664905e+01,   2.21519935e-01,
         -8.98471500e+00],
       [  2.79927923e-02,  -6.47413499e-03,  -4.65032974e-03,
         -9.11915792e-05,  -7.09995043e-07,   2.88996808e-01,
          2.96533992e-01,   2.17484783e-06,   5.85537247e-01,
         -4.41769477e-02,   9.44084961e-01,   1.10446260e+00,
         -1.77641433e-02,  -1.16345783e-02,   1.06910449e-04,
         -3.97892514e-06,   6.48737018e-01,   6.54122444e-01,
          7.23332825e-06,   1.30286920e+00,   2.57342958e-02,
         -9.94809229e-01],
       [ -4.52336376e-03,   1.12720168e-03,   7.06127043e-04,
         -9.69030951e-05,   4.99022493e-08,  -4.72719877e-02,
         -4.85430090e-02,  -3.72258402e-07,  -9.58160415e-02,
          7.60046581e-03,  -1.57647219e-01,  -1.77641433e-02,
          3.36397057e-01,  -3.31467154e-01,   3.33148782e-01,
          6.48280169e-07,  -1.10721082e-01,  -1.11359300e-01,
         -1.24573832e-06,  -2.22082017e-01,  -4.31798312e-03,
          1.66227863e-01],
       [ -3.19153313e-03,   6.65975324e-04,   5.70628012e-04,
          1.10871208e-04,   1.25126639e-07,  -3.20903386e-02,
         -3.28300679e-02,  -2.37474685e-07,  -6.49211051e-02,
          4.40314263e-03,  -1.01614378e-01,  -1.16345782e-02,
         -3.31467154e-01,   3.34724606e-01,  -3.33166931e-01,
          1.53803243e-07,  -7.24652815e-02,  -7.33115456e-02,
         -8.25155879e-07,  -1.45777871e-01,  -2.87376565e-03,
          1.06660263e-01],
       [ -2.12478243e-04,  -8.54456752e-05,   1.21477378e-04,
          1.96507144e-04,   5.98111693e-08,  -1.03465141e-03,
         -9.93740661e-04,   5.78847653e-09,  -2.02841435e-03,
         -6.39342036e-04,   1.41680339e-03,   1.06910435e-04,
          3.33148782e-01,  -3.33166931e-01,   3.33632550e-01,
         -3.05843010e-07,   8.89526217e-04,   3.82043685e-04,
          6.39603796e-09,   1.27159856e-03,   7.22817110e-05,
         -1.80081618e-03],
       [ -7.58939820e-07,   2.69591918e-07,   2.36825817e-08,
         -1.26995262e-07,   5.61532670e-10,  -8.98058734e-06,
         -9.45571666e-06,  -5.64257355e-11,  -1.84364954e-05,
          2.71597678e-06,  -3.08327411e-05,  -3.97892516e-06,
          6.48280173e-07,   1.53803245e-07,  -3.05843011e-07,
          3.32945916e-09,  -2.49257010e-05,  -2.50532257e-05,
         -1.39475606e-10,  -4.99793501e-05,  -2.00714424e-06,
          3.18320308e-05],
       [  1.73940100e-01,  -4.02323286e-02,  -2.88535930e-02,
         -5.45137151e-04,  -4.53428804e-06,   1.79507268e+00,
          1.84180063e+00,   1.34996270e-05,   3.63691333e+00,
         -2.74680971e-01,   5.85909735e+00,   6.48737018e-01,
         -1.10721082e-01,  -7.24652815e-02,   8.89526302e-04,
         -2.49257009e-05,   5.02896210e+00,   4.06244917e+00,
          4.48464639e-05,   8.09147173e+00,   1.60593877e-01,
         -6.17397454e+00],
       [  1.75416023e-01,  -4.05618673e-02,  -2.90940300e-02,
         -5.56502539e-04,  -4.66806707e-06,   1.81014215e+00,
          1.85728240e+00,   1.36072150e-05,   3.66746490e+00,
         -2.77018832e-01,   5.90730505e+00,   6.54122444e-01,
         -1.11359300e-01,  -7.33115456e-02,   3.82043769e-04,
         -2.50532256e-05,   4.06244917e+00,   5.09618068e+00,
          4.52206519e-05,   8.15869083e+00,   1.62055792e-01,
         -6.22473310e+00],
       [  1.93822142e-06,  -4.56456320e-07,  -3.16099719e-07,
          7.42332773e-09,  -3.40101610e-11,   1.98435497e-05,
          2.03183246e-05,   1.57302290e-10,   4.01622972e-05,
         -2.93986527e-06,   6.49029951e-05,   7.23332825e-06,
         -1.24573832e-06,  -8.25155879e-07,   6.39603883e-09,
         -1.39475605e-10,   4.48464638e-05,   4.52206518e-05,
          5.50303464e-10,   9.00677861e-05,   1.67611480e-06,
         -6.83716016e-05],
       [  3.49358815e-01,  -8.07948281e-02,  -5.79480316e-02,
         -1.10161293e-03,  -9.20269532e-06,   3.60524225e+00,
          3.69911112e+00,   2.71070513e-05,   7.30443375e+00,
         -5.51704086e-01,   1.17664905e+01,   1.30286920e+00,
         -2.22082017e-01,  -1.45777871e-01,   1.27159873e-03,
         -4.99793499e-05,   8.09147173e+00,   8.15869083e+00,
          9.00677861e-05,   1.72502840e+01,   3.22652143e-01,
         -1.23988009e+01],
       [  7.50413483e-03,  -1.82755248e-03,  -9.72034297e-04,
          2.00126420e-04,  -9.85895924e-07,   7.43153092e-02,
          7.59495208e-02,   5.34047103e-07,   1.50266366e-01,
         -1.34625628e-02,   2.21519931e-01,   2.57342954e-02,
         -4.31798304e-03,  -2.87376560e-03,   7.22816977e-05,
         -2.00714421e-06,   1.60593874e-01,   1.62055789e-01,
          1.67611476e-06,   3.22652138e-01,   1.00811494e+00,
         -2.37522468e-01],
       [ -2.62460774e-01,   6.13779113e-02,   4.33381943e-02,
          1.25961376e-04,   5.74031972e-06,  -2.71977382e+00,
         -2.79185694e+00,  -2.06537183e-05,  -5.51169132e+00,
          4.14437237e-01,  -8.98471500e+00,  -9.94809229e-01,
          1.66227863e-01,   1.06660264e-01,  -1.80081633e-03,
          3.18320307e-05,  -6.17397454e+00,  -6.22473310e+00,
         -6.83716017e-05,  -1.23988009e+01,  -2.37522472e-01,
          1.04772248e+01]])
      jac: array([ -1.61673501e-03,  -1.15722486e+00,  -1.26849429e+00,
        -1.11309804e-01,  -3.09028226e+01,  -1.01839006e-02,
        -9.96306911e-03,  -7.25089866e+02,  -2.01469287e-02,
        -1.01473555e-03,   1.15709379e-03,  -2.24560499e-04,
        -1.07990900e+00,  -7.07769312e-01,   3.72093629e-01,
        -1.47367442e+02,  -1.95202976e-03,  -1.75292417e-03,
        -7.84959976e+02,  -3.70492041e-03,   4.37676907e-04,
        -2.66758353e-03])
  message: 'Desired error not necessarily achieved due to precision loss.'
     nfev: 4452
      nit: 48
     njev: 185
   status: 2
  success: False
        x: array([ -3.20889907e-02,   1.10602436e-02,   1.26205546e-02,
        -3.74474669e-03,  -5.94367708e-06,  -2.79859775e-01,
        -2.83783138e-01,  -8.36086136e-06,  -5.63650882e-01,
        -9.45846565e-02,  -8.37924943e-01,  -6.82393779e-02,
         1.32464843e-02,   1.29986712e-02,   4.68819670e-03,
        -6.54666855e-06,  -4.05330334e-01,  -4.08653704e-01,
        -8.81567097e-06,  -8.13978862e-01,   7.15892934e-02,
         7.69420643e-01])
[ -3.20889907e-02   1.10602436e-02   1.26205546e-02  -3.74474669e-03
  -5.94367708e-06  -2.79859775e-01  -2.83783138e-01  -8.36086136e-06
  -5.63650882e-01  -9.45846565e-02  -8.37924943e-01  -6.82393779e-02
   1.32464843e-02   1.29986712e-02   4.68819670e-03  -6.54666855e-06
  -4.05330334e-01  -4.08653704e-01  -8.81567097e-06  -8.13978862e-01
   7.15892934e-02   7.69420643e-01]
"""
